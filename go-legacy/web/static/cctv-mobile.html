<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mobile CCTV</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #000;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        video {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: #000;
        }

        .overlay {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 24px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
        }

        .overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .overlay.connected .status-dot {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .controls.visible {
            opacity: 1;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            background: rgba(0,0,0,0.8);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 99;
        }

        .spinner.hidden {
            display: none;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 101;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        .error-message button {
            margin-top: 15px;
            padding: 10px 20px;
            background: white;
            color: #f44336;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <video id="cctv" autoplay playsinline muted></video>

    <div class="spinner" id="spinner"></div>

    <div class="overlay" id="overlay">
        <div class="status-dot"></div>
        <span id="statusText">ì—°ê²° ì¤‘...</span>
    </div>

    <div class="controls" id="controls">
        <button class="control-btn" id="muteBtn" title="ìŒì†Œê±°">ğŸ”‡</button>
        <button class="control-btn" id="reconnectBtn" title="ì¬ì—°ê²°">ğŸ”„</button>
    </div>

    <div class="error-message" id="errorMessage">
        <div id="errorText">ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>
        <button id="retryBtn">ë‹¤ì‹œ ì‹œë„</button>
    </div>

    <script src="/static/js/websocket-manager.js"></script>
    <script src="/static/js/webrtc-engine.js"></script>
    <script>
        // URLì—ì„œ ìŠ¤íŠ¸ë¦¼ ID ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const streamId = urlParams.get('stream') || 'camera1';

        // ì—˜ë¦¬ë¨¼íŠ¸ ì°¸ì¡°
        const videoElement = document.getElementById('cctv');
        const overlay = document.getElementById('overlay');
        const statusText = document.getElementById('statusText');
        const controls = document.getElementById('controls');
        const muteBtn = document.getElementById('muteBtn');
        const reconnectBtn = document.getElementById('reconnectBtn');
        const spinner = document.getElementById('spinner');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const retryBtn = document.getElementById('retryBtn');

        let engine = null;
        let hideOverlayTimer = null;
        let hideControlsTimer = null;

        // WebRTC Engine ì´ˆê¸°í™”
        function initEngine() {
            if (engine) {
                engine.disconnect();
            }

            engine = new WebRTCEngine({
                streamId: streamId,
                videoElement: videoElement,
                autoReconnect: true,
                reconnectDelay: 3000
            });

            setupEngineEvents();
            return engine;
        }

        // ì—”ì§„ ì´ë²¤íŠ¸ ì„¤ì •
        function setupEngineEvents() {
            engine.on('connected', () => {
                statusText.textContent = `âœ… ${streamId}`;
                overlay.classList.add('connected');
                spinner.classList.add('hidden');
                errorMessage.classList.remove('visible');

                // 3ì´ˆ í›„ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                hideOverlayTimer = setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 3000);
            });

            engine.on('disconnected', () => {
                statusText.textContent = 'ì—°ê²° ëŠê¹€';
                overlay.classList.remove('connected', 'hidden');
                spinner.classList.add('hidden');
            });

            engine.on('error', (error) => {
                console.error('Engine error:', error);
                statusText.textContent = 'ì—°ê²° ì˜¤ë¥˜';
                overlay.classList.remove('connected', 'hidden');
                spinner.classList.add('hidden');

                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                errorText.textContent = error.message || 'ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                errorMessage.classList.add('visible');
            });

            engine.on('stats', (stats) => {
                if (!overlay.classList.contains('hidden')) {
                    statusText.textContent = `${stats.bitrate.toFixed(0)} kbps`;
                }
            });

            engine.on('statechange', (state) => {
                if (state === 'connecting') {
                    spinner.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                    statusText.textContent = 'ì—°ê²° ì¤‘...';
                }
            });
        }

        // í™”ë©´ í„°ì¹˜ë¡œ ì˜¤ë²„ë ˆì´/ì»¨íŠ¸ë¡¤ í† ê¸€
        let tapCount = 0;
        let tapTimer = null;

        document.body.addEventListener('click', (e) => {
            // ë²„íŠ¼ í´ë¦­ì€ ë¬´ì‹œ
            if (e.target.tagName === 'BUTTON') return;

            tapCount++;

            if (tapCount === 1) {
                // ë‹¨ì¼ íƒ­: ì˜¤ë²„ë ˆì´/ì»¨íŠ¸ë¡¤ í† ê¸€
                tapTimer = setTimeout(() => {
                    toggleOverlay();
                    tapCount = 0;
                }, 300);
            } else if (tapCount === 2) {
                // ë”ë¸” íƒ­: ì „ì²´í™”ë©´ í† ê¸€
                clearTimeout(tapTimer);
                toggleFullscreen();
                tapCount = 0;
            }
        });

        // ì˜¤ë²„ë ˆì´ í† ê¸€
        function toggleOverlay() {
            const isHidden = overlay.classList.contains('hidden');

            if (isHidden) {
                overlay.classList.remove('hidden');
                controls.classList.add('visible');

                // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€
                clearTimeout(hideOverlayTimer);
                clearTimeout(hideControlsTimer);
                hideOverlayTimer = setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 5000);
                hideControlsTimer = setTimeout(() => {
                    controls.classList.remove('visible');
                }, 5000);
            } else {
                overlay.classList.add('hidden');
                controls.classList.remove('visible');
            }
        }

        // ì „ì²´í™”ë©´ í† ê¸€
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                if (videoElement.requestFullscreen) {
                    videoElement.requestFullscreen();
                } else if (videoElement.webkitRequestFullscreen) {
                    videoElement.webkitRequestFullscreen();
                } else if (videoElement.webkitEnterFullscreen) {
                    videoElement.webkitEnterFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        }

        // ìŒì†Œê±° í† ê¸€
        muteBtn.addEventListener('click', () => {
            videoElement.muted = !videoElement.muted;
            muteBtn.textContent = videoElement.muted ? 'ğŸ”‡' : 'ğŸ”Š';
        });

        // ì¬ì—°ê²°
        reconnectBtn.addEventListener('click', () => {
            initEngine();
            engine.connect();
        });

        // ì—ëŸ¬ ì¬ì‹œë„
        retryBtn.addEventListener('click', () => {
            errorMessage.classList.remove('visible');
            initEngine();
            engine.connect();
        });

        // í™”ë©´ íšŒì „ ê°ì§€
        window.addEventListener('orientationchange', () => {
            // í™”ë©´ íšŒì „ ì‹œ ë¹„ë””ì˜¤ ì¬ì¡°ì •
            setTimeout(() => {
                videoElement.style.width = '100vw';
                videoElement.style.height = '100vh';
            }, 100);
        });

        // ì ˆì „ ëª¨ë“œ ë°©ì§€ (ê°€ëŠ¥í•œ ê²½ìš°)
        if ('wakeLock' in navigator) {
            let wakeLock = null;

            async function requestWakeLock() {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock í™œì„±í™”');
                } catch (err) {
                    console.error('Wake Lock ì‹¤íŒ¨:', err);
                }
            }

            requestWakeLock();

            document.addEventListener('visibilitychange', () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    requestWakeLock();
                }
            });
        }

        // ì´ˆê¸° ì—°ê²°
        initEngine();
        engine.connect();

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (engine) {
                engine.disconnect();
            }
        });

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ë³µê·€ ì‹œ ì¬ì—°ê²° í™•ì¸
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && engine && !engine.isConnected()) {
                console.log('í˜ì´ì§€ í™œì„±í™” - ì¬ì—°ê²° ì‹œë„');
                engine.connect();
            }
        });
    </script>
</body>
</html>

