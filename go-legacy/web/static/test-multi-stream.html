<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Stream Test - Single WebSocket</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1419;
            color: #ffffff;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .info-box {
            background: #192734;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #1d9bf0;
        }

        .info-box h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #1d9bf0;
        }

        .info-box p {
            font-size: 14px;
            color: #8899a6;
            line-height: 1.6;
        }

        .controls {
            background: #192734;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        button {
            background: #1d9bf0;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-right: 10px;
        }

        button:hover {
            background: #1a8cd8;
        }

        button.disconnect {
            background: #f4212e;
        }

        button.disconnect:hover {
            background: #d9182b;
        }

        .ws-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #0f1419;
            border-radius: 6px;
            margin-left: 10px;
        }

        .ws-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #657786;
        }

        .ws-dot.connected {
            background: #17bf63;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stream-card {
            background: #192734;
            border-radius: 12px;
            overflow: hidden;
        }

        .stream-header {
            padding: 15px;
            background: #0f1419;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-title {
            font-size: 16px;
            font-weight: 600;
        }

        .stream-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #8899a6;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #657786;
        }

        .status-dot.connected {
            background: #17bf63;
        }

        .status-dot.connecting {
            background: #ffad1f;
        }

        .status-dot.error {
            background: #f4212e;
        }

        .video-wrapper {
            background: #000000;
            position: relative;
            aspect-ratio: 16/9;
        }

        video {
            width: 100%;
            height: 100%;
            display: block;
        }

        .stream-stats {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 12px;
        }

        .stat {
            color: #8899a6;
        }

        .stat strong {
            color: #ffffff;
        }

        .logs {
            background: #192734;
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .logs h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #657786;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 4px 0;
            border-bottom: 1px solid #0f1419;
        }

        .log-info { color: #8899a6; }
        .log-error { color: #f4212e; }
        .log-warn { color: #ffad1f; }
        .log-success { color: #17bf63; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”— Multi-Stream Test - Single WebSocket Connection</h1>
        </header>

        <div class="info-box">
            <h3>ğŸ’¡ ì´ í˜ì´ì§€ëŠ” ë¬´ì—‡ì„ í…ŒìŠ¤íŠ¸í•˜ë‚˜ìš”?</h3>
            <p>
                <strong>ë‹¨ì¼ WebSocket ì—°ê²°ë¡œ ì—¬ëŸ¬ ìŠ¤íŠ¸ë¦¼ì„ ë™ì‹œì— ê´€ë¦¬í•©ë‹ˆë‹¤.</strong><br>
                ê¸°ì¡´ ë°©ì‹ì€ ê° ì˜ìƒë§ˆë‹¤ ë³„ë„ì˜ WebSocket ì—°ê²°ì„ ìƒì„±í–ˆì§€ë§Œ, ì´ì œëŠ” ë¸Œë¼ìš°ì €ë‹¹ í•˜ë‚˜ì˜ WebSocketë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
                ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ 3ê°œì˜ ìŠ¤íŠ¸ë¦¼ì„ ë™ì‹œì— ì—°ê²°í•´ë³´ì„¸ìš”. WebSocketì€ ë‹¨ 1ê°œë§Œ ìƒì„±ë©ë‹ˆë‹¤!
            </p>
        </div>

        <div class="controls">
            <button id="connectAllBtn">ëª¨ë“  ìŠ¤íŠ¸ë¦¼ ì—°ê²° (3ê°œ)</button>
            <button id="disconnectAllBtn" class="disconnect">ëª¨ë“  ìŠ¤íŠ¸ë¦¼ í•´ì œ</button>
            <button id="addStreamBtn">ìŠ¤íŠ¸ë¦¼ 1ê°œ ë” ì¶”ê°€</button>

            <div class="ws-status">
                <div class="ws-dot" id="wsDot"></div>
                <span id="wsStatus">WebSocket: ëŒ€ê¸° ì¤‘</span>
            </div>
        </div>

        <div class="grid" id="streamGrid"></div>

        <div class="logs">
            <h3>í™œë™ ë¡œê·¸ (WebSocket ê´€ë¦¬ì í¬í•¨)</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script src="/static/js/websocket-manager.js"></script>
    <script src="/static/js/webrtc-engine.js"></script>
    <script>
        console.log('ğŸ” ========== test-multi-stream.html loaded ==========');
        console.log('ğŸ” WebSocketManager class available?', typeof WebSocketManager !== 'undefined');
        console.log('ğŸ” WebRTCEngine class available?', typeof WebRTCEngine !== 'undefined');

        const engines = [];
        const streamGrid = document.getElementById('streamGrid');
        const logContainer = document.getElementById('logContainer');

        console.log('ğŸ” Getting initial WebSocketManager instance...');
        const wsManager = WebSocketManager.getInstance();
        console.log('ğŸ” WebSocketManager instance:', wsManager);
        console.log('ğŸ” WebSocketManager instance ID:', wsManager.instanceId);

        let streamCounter = 0;

        // ì´ˆê¸° ìƒíƒœ í‘œì‹œ
        updateWSStatus('disconnected', 'WebSocket: ëŒ€ê¸° ì¤‘');

        // WebSocket ìƒíƒœ ëª¨ë‹ˆí„°ë§
        wsManager.on('open', () => {
            console.log('ğŸ” WebSocket "open" event handler called');
            updateWSStatus('connected', 'WebSocket: ì—°ê²°ë¨ âœ“');
            log('WebSocket ì—°ê²° ì„±ê³µ (ê³µìœ  ì—°ê²°)', 'success');
        });

        wsManager.on('close', () => {
            console.log('ğŸ” WebSocket "close" event handler called');
            updateWSStatus('disconnected', 'WebSocket: ì—°ê²° ëŠê¹€');
            log('WebSocket ì—°ê²° ì¢…ë£Œ', 'warn');
        });

        wsManager.on('error', (error) => {
            console.log('ğŸ” WebSocket "error" event handler called:', error);
            updateWSStatus('error', 'WebSocket: ì˜¤ë¥˜');
            log('WebSocket ì˜¤ë¥˜: ' + error, 'error');
        });

        // ìŠ¤íŠ¸ë¦¼ ëª©ë¡ ë¡œë“œ
        async function loadStreams() {
            try {
                const response = await fetch('/v3/config/paths/list');
                const data = await response.json();
                const streams = data.items; // response ë°›ëŠ” ëŒ€ë¡œ ì²˜ë¦¬

                log(`ğŸ“‹ ìŠ¤íŠ¸ë¦¼ ëª©ë¡ ë¡œë“œë¨: ${streams.length}ê°œ`, 'info');

                // ëª¨ë“  ìŠ¤íŠ¸ë¦¼ ë°˜í™˜
                streams.forEach(s => {
                    log(`  - ${s.name}: ${s.source}`, 'info');
                });

                return streams;
            } catch (error) {
                log('ìŠ¤íŠ¸ë¦¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
                return [];
            }
        }

        // ì˜¨ë””ë§¨ë“œ ìŠ¤íŠ¸ë¦¼ ì‹œì‘ (í•„ìš” ì‹œ)
        async function startStream(streamId) {
            // v3 APIì—ì„œëŠ” ìë™ìœ¼ë¡œ ì˜¨ë””ë§¨ë“œ ì²˜ë¦¬ë˜ë¯€ë¡œ ë³„ë„ ì‹œì‘ ë¶ˆí•„ìš”
            // WebRTC ì—°ê²° ì‹œ ìë™ìœ¼ë¡œ ì‹œì‘ë¨
            log(`â„¹ï¸ ìŠ¤íŠ¸ë¦¼ ì¤€ë¹„: ${streamId}`, 'info');
            return true;
        }

        // ìŠ¤íŠ¸ë¦¼ ì¹´ë“œ ìƒì„±
        function createStreamCard(streamId) {
            const card = document.createElement('div');
            card.className = 'stream-card';
            card.id = 'card-' + streamCounter;

            card.innerHTML = `
                <div class="stream-header">
                    <div class="stream-title">${streamId}</div>
                    <div class="stream-status">
                        <div class="status-dot" id="dot-${streamCounter}"></div>
                        <span id="status-${streamCounter}">ëŒ€ê¸° ì¤‘</span>
                    </div>
                </div>
                <div class="video-wrapper">
                    <video id="video-${streamCounter}" autoplay playsinline muted></video>
                </div>
                <div class="stream-stats">
                    <div class="stat">ë¹„íŠ¸ë ˆì´íŠ¸: <strong id="bitrate-${streamCounter}">0 kbps</strong></div>
                    <div class="stat">íŒ¨í‚·: <strong id="packets-${streamCounter}">0</strong></div>
                    <div class="stat">ICE: <strong id="ice-${streamCounter}">-</strong></div>
                    <div class="stat">ë°”ì´íŠ¸: <strong id="bytes-${streamCounter}">0 B</strong></div>
                </div>
            `;

            streamGrid.appendChild(card);
            return streamCounter++;
        }

        // ìŠ¤íŠ¸ë¦¼ ì—°ê²°
        async function connectStream(streamId) {
            console.log(`ğŸ” ========== connectStream("${streamId}") ==========`);
            const index = createStreamCard(streamId);
            const videoElement = document.getElementById('video-' + index);

            log(`ğŸ¬ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹œë„: ${streamId} (ì¸ë±ìŠ¤: ${index})`, 'info');

            console.log(`ğŸ” Creating WebRTCEngine for ${streamId}...`);
            const engine = new WebRTCEngine({
                streamId: streamId,
                videoElement: videoElement
            });

            console.log(`ğŸ” WebRTCEngine created for ${streamId}`);
            console.log(`ğŸ” Current WebSocketManager streams:`, wsManager.streamHandlers.size);

            engine.on('connected', () => {
                updateStreamStatus(index, 'connected', 'ì—°ê²°ë¨');
                log(`${streamId} ì—°ê²° ì„±ê³µ`, 'success');
            });

            engine.on('disconnected', () => {
                updateStreamStatus(index, 'disconnected', 'ì—°ê²° ëŠê¹€');
                log(`${streamId} ì—°ê²° ì¢…ë£Œ`, 'warn');
            });

            engine.on('error', (error) => {
                updateStreamStatus(index, 'error', 'ì˜¤ë¥˜');
                log(`${streamId} ì˜¤ë¥˜: ${error.message}`, 'error');
            });

            engine.on('statechange', (state) => {
                document.getElementById('ice-' + index).textContent = state;
                if (state === 'connecting') {
                    updateStreamStatus(index, 'connecting', 'ì—°ê²° ì¤‘...');
                }
            });

            engine.on('stats', (stats) => {
                document.getElementById('packets-' + index).textContent = stats.packetsReceived.toLocaleString();
                document.getElementById('bytes-' + index).textContent = formatBytes(stats.bytesReceived);
                document.getElementById('bitrate-' + index).textContent = stats.bitrate.toFixed(2) + ' kbps';
            });

            engines.push({ engine, streamId, index });

            try {
                await engine.connect();
            } catch (error) {
                log(`${streamId} ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ëª¨ë“  ìŠ¤íŠ¸ë¦¼ ì—°ê²°
        async function connectAll() {
            const streams = await loadStreams();
            if (streams.length === 0) {
                log('âŒ ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const count = Math.min(3, streams.length);
            log(`ğŸš€ ${count}ê°œì˜ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹œì‘ (WebSocketì€ 1ê°œë§Œ ì‚¬ìš©)`, 'info');

            // ìµœëŒ€ 3ê°œ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
            for (let i = 0; i < count; i++) {
                await connectStream(streams[i].name);
                // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì—°ê²°
                await new Promise(resolve => setTimeout(resolve, 800));
            }
        }

        // ëª¨ë“  ìŠ¤íŠ¸ë¦¼ í•´ì œ
        function disconnectAll() {
            log('ëª¨ë“  ìŠ¤íŠ¸ë¦¼ ì—°ê²° í•´ì œ', 'info');
            engines.forEach(({ engine }) => {
                engine.disconnect();
            });
            engines.length = 0;
            streamGrid.innerHTML = '';
            streamCounter = 0;
        }

        // ìŠ¤íŠ¸ë¦¼ 1ê°œ ì¶”ê°€
        async function addOneStream() {
            const streams = await loadStreams();
            if (streams.length === 0) {
                log('âŒ ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            // ì•„ì§ ì—°ê²°í•˜ì§€ ì•Šì€ ìŠ¤íŠ¸ë¦¼ ì°¾ê¸°
            const connectedIds = engines.map(e => e.streamId);
            const available = streams.find(s => !connectedIds.includes(s.name));

            if (available) {
                await connectStream(available.name);
            } else {
                log('âš ï¸ ëª¨ë“  ìŠ¤íŠ¸ë¦¼ì´ ì´ë¯¸ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'warn');
            }
        }

        // WebSocket ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateWSStatus(status, text) {
            const dot = document.getElementById('wsDot');
            const statusText = document.getElementById('wsStatus');
            dot.className = 'ws-dot ' + (status === 'disconnected' ? '' : status);
            statusText.textContent = text;
        }

        // ìŠ¤íŠ¸ë¦¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStreamStatus(index, status, text) {
            const dot = document.getElementById('dot-' + index);
            const statusText = document.getElementById('status-' + index);
            if (dot && statusText) {
                dot.className = 'status-dot ' + status;
                statusText.textContent = text;
            }
        }

        // ë°”ì´íŠ¸ í¬ë§·íŒ…
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ë¡œê·¸
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // ìµœëŒ€ 100ê°œì˜ ë¡œê·¸ë§Œ ìœ ì§€
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('connectAllBtn').addEventListener('click', connectAll);
        document.getElementById('disconnectAllBtn').addEventListener('click', disconnectAll);
        document.getElementById('addStreamBtn').addEventListener('click', addOneStream);

        // ì´ˆê¸°í™”
        log('Multi-Stream Test í˜ì´ì§€ ë¡œë“œë¨', 'info');
        log('ë‹¨ì¼ WebSocketìœ¼ë¡œ ì—¬ëŸ¬ ìŠ¤íŠ¸ë¦¼ì„ ê´€ë¦¬í•©ë‹ˆë‹¤', 'info');
    </script>
</body>
</html>

