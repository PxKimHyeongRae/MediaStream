# ì„¸ì…˜ ìš”ì•½ - RTP íŒ¨í‚· ìˆ˜ì‹  ì™„ì„±

**ì‘ì—…ì¼**: 2025-10-29
**ì†Œìš” ì‹œê°„**: ~1ì‹œê°„
**ìƒíƒœ**: âœ… Phase 3 ìš°ì„ ìˆœìœ„ 1 ì™„ë£Œ

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

Phase 2 ì™„ë£Œ í›„ ë‚¨ì•„ìˆë˜ **RTP íŒ¨í‚· ìˆ˜ì‹  placeholder ë¬¸ì œ**ë¥¼ í•´ê²°í•˜ì—¬ ì™„ì „í•œ RTSP â†’ WebRTC íŒŒì´í”„ë¼ì¸ì„ ì™„ì„±

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. gortsplib v4 API ì¡°ì‚¬
- **ë¬¸ì œ**: Phase 2ì—ì„œ `readPackets()` í•¨ìˆ˜ê°€ placeholderë¡œ ë‚¨ì•„ìˆì—ˆìŒ
- **ì›ì¸**: gortsplib v4 API ë³€ê²½ìœ¼ë¡œ `OnPacketRTP` ì½œë°± ì œê±°ë¨
- **í•´ê²°**: Explore ì—ì´ì „íŠ¸ë¥¼ í™œìš©í•˜ì—¬ ì˜¬ë°”ë¥¸ API ë°œê²¬
  - `OnPacketRTPAny()` - ëª¨ë“  ë¯¸ë””ì–´ íŠ¸ë™ì˜ íŒ¨í‚·ì„ í•˜ë‚˜ì˜ ì½œë°±ìœ¼ë¡œ ìˆ˜ì‹ 
  - `OnPacketRTP()` - íŠ¹ì • ë¯¸ë””ì–´/í¬ë§·ë³„ ê°œë³„ ì½œë°±

### 2. RTSP í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ìˆ˜ì •
**íŒŒì¼**: `internal/rtsp/client.go`

#### ë³€ê²½ì‚¬í•­:
1. **Import ì¶”ê°€**:
   ```go
   "github.com/bluenviron/gortsplib/v4/pkg/description"
   "github.com/bluenviron/gortsplib/v4/pkg/format"
   ```

2. **ë¯¸ë””ì–´ ì •ë³´ ë¡œê¹… ì¶”ê°€**:
   ```go
   for i, media := range desc.Medias {
       for j, forma := range media.Formats {
           c.logger.Info("Media format detected",
               zap.Int("media_index", i),
               zap.Int("format_index", j),
               zap.String("codec", forma.Codec()),
               zap.Uint8("payload_type", forma.PayloadType()),
           )
       }
   }
   ```

3. **RTP íŒ¨í‚· ì½œë°± ë“±ë¡** (í•µì‹¬ ìˆ˜ì •):
   ```go
   // SetupAll() ì´í›„, Play() ì´ì „ì— ë“±ë¡
   c.client.OnPacketRTPAny(func(medi *description.Media, forma format.Format, pkt *rtp.Packet) {
       // RTP íŒ¨í‚· ìˆ˜ì‹  ì‹œ ìë™ í˜¸ì¶œë¨
       c.handleRTPPacket(pkt)
   })

   c.logger.Info("RTP packet callback registered")
   ```

4. **ë¶ˆí•„ìš”í•œ ì½”ë“œ ì œê±°**:
   - `go c.readPackets()` í˜¸ì¶œ ì œê±°
   - `readPackets()` í•¨ìˆ˜ ì™„ì „ ì‚­ì œ (268-282 ë¼ì¸)

### 3. ë¹Œë“œ ê²€ì¦
```bash
$ go build -o bin/media-server.exe cmd/server/main.go
âœ… ë¹Œë“œ ì„±ê³µ

$ ls -lh bin/media-server.exe
-rwxr-xr-x 1 user group 18M Oct 29 10:57 bin/media-server.exe
```

### 4. ë¬¸ì„œ ì‘ì„±
1. **`docs/PHASE3_RTP_FIX.md`** (ì‹ ê·œ ì‘ì„±)
   - ë¬¸ì œ ì •ì˜
   - ì¡°ì‚¬ ê²°ê³¼ (gortsplib v4 API ë¶„ì„)
   - êµ¬í˜„ ë‚´ìš© (ì½”ë“œ ì˜ˆì‹œ í¬í•¨)
   - ì „ì²´ ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ë¨
   - ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´

2. **`docs/PHASE2_COMPLETE.md`** (ì—…ë°ì´íŠ¸)
   - "í˜„ì¬ ì œí•œì‚¬í•­" ì„¹ì…˜: RTP íŒ¨í‚· ì½ê¸° ì´ìŠˆ â†’ âœ… í•´ê²°ë¨ìœ¼ë¡œ ë³€ê²½
   - "ë‹¤ìŒ ë‹¨ê³„" ì„¹ì…˜: ìš°ì„ ìˆœìœ„ 1 â†’ âœ… ì™„ë£Œ í‘œì‹œ

---

## ğŸ“Š ê¸°ìˆ ì  ê°œì„ ì‚¬í•­

### Before (Phase 2)
```go
// âŒ Placeholder - ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
func (c *Client) readPackets() {
    for {
        select {
        case <-c.ctx.Done():
            return
        default:
            // ì£¼ì„ë§Œ ìˆê³  ì‹¤ì œ êµ¬í˜„ ì—†ìŒ
            time.Sleep(time.Millisecond)
        }
    }
}

// run() í•¨ìˆ˜ì—ì„œ
go c.readPackets()  // âŒ ë¶ˆí•„ìš”í•œ ê³ ë£¨í‹´
```

### After (Phase 3)
```go
// âœ… gortsplibì˜ ìë™ ì½œë°± í™œìš©
c.client.OnPacketRTPAny(func(medi *description.Media, forma format.Format, pkt *rtp.Packet) {
    c.handleRTPPacket(pkt)  // âœ… ìë™ í˜¸ì¶œë¨
})

// readPackets() í•¨ìˆ˜ ì‚­ì œë¨ - ë” ì´ìƒ í•„ìš” ì—†ìŒ
// gortsplibê°€ ë‚´ë¶€ì ìœ¼ë¡œ íŒ¨í‚· ì½ê¸°ë¥¼ ì²˜ë¦¬í•˜ê³  ì½œë°± ìë™ í˜¸ì¶œ
```

### í•µì‹¬ ê°œì„ ì 
1. **ì˜¬ë°”ë¥¸ API ì‚¬ìš©**: gortsplib v4ì˜ ê³µì‹ íŒ¨í„´ ì‚¬ìš©
2. **íš¨ìœ¨ì„±**: ë¶ˆí•„ìš”í•œ ê³ ë£¨í‹´ ì œê±°
3. **ë””ë²„ê¹…**: ë¯¸ë””ì–´ í¬ë§· ë¡œê¹…ìœ¼ë¡œ ì§„ë‹¨ ìš©ì´
4. **ì•ˆì •ì„±**: í–¥í›„ ë²„ì „ í˜¸í™˜ì„± ë³´ì¥

---

## ğŸ”„ ì™„ì„±ëœ ë°ì´í„° í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RTSP Camera     â”‚  rtsp://admin:pass@192.168.4.121:554/...
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ RTSP Protocol (TCP/UDP)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ gortsplib Client â”‚
â”‚  Start()         â”‚
â”‚  Describe()      â”‚
â”‚  SetupAll()      â”‚
â”‚  OnPacketRTPAny()â”‚ â—„â”€â”€â”€ ì½œë°± ë“±ë¡ (í•µì‹¬!)
â”‚  Play()          â”‚
â”‚  Wait()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ RTP Packets
         â”‚ [gortsplib ë‚´ë¶€ ê³ ë£¨í‹´ì´ ìë™ìœ¼ë¡œ ì½ìŒ]
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OnPacketRTPAny()   â”‚ â—„â”€â”€â”€ ìë™ í˜¸ì¶œ!
â”‚ Callback Handler   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handleRTPPacket()  â”‚
â”‚  - í†µê³„ ì—…ë°ì´íŠ¸    â”‚
â”‚  - onPacket() í˜¸ì¶œ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stream.WritePacket() â”‚
â”‚  - ë²„í¼ì— ì €ì¥        â”‚
â”‚  - êµ¬ë…ìì—ê²Œ ë°°í¬    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebRTC Peer          â”‚
â”‚  OnPacket()          â”‚
â”‚  videoTrack.WriteRTP()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ WebRTC/SRTP
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web Browser          â”‚
â”‚ <video> ì¬ìƒ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ë³€ê²½ëœ íŒŒì¼

| íŒŒì¼ | ìƒíƒœ | ì„¤ëª… |
|------|------|------|
| `internal/rtsp/client.go` | ìˆ˜ì • | OnPacketRTPAny ì½œë°± ì¶”ê°€, readPackets ì œê±° |
| `docs/PHASE3_RTP_FIX.md` | ì‹ ê·œ | ìƒì„¸ ê¸°ìˆ  ë¬¸ì„œ |
| `docs/PHASE2_COMPLETE.md` | ì—…ë°ì´íŠ¸ | ì´ìŠˆ í•´ê²° ìƒíƒœ ë°˜ì˜ |
| `docs/SESSION_SUMMARY.md` | ì‹ ê·œ | ì´ íŒŒì¼ |
| `bin/media-server.exe` | ì¬ë¹Œë“œ | 18MB (ë³€ê²½ ì—†ìŒ) |

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ê°€ëŠ¥í•œ ì‘ì—…: ì‹¤ì œ í…ŒìŠ¤íŠ¸ ğŸ¬

ì„œë²„ë¥¼ ì‹¤í–‰í•˜ê³  í…ŒìŠ¤íŠ¸í•  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

```bash
# 1. ì„œë²„ ì‹¤í–‰
./bin/media-server.exe

# 2. ì›¹ ë¸Œë¼ìš°ì € ì ‘ì†
http://localhost:8080

# 3. "Connect" ë²„íŠ¼ í´ë¦­

# 4. ë¡œê·¸ í™•ì¸
# ì˜ˆìƒ ì¶œë ¥:
# [INFO] Connected to RTSP server
# [INFO] Stream description received (media_count=2)
# [INFO] Media format detected (codec="H264")
# [INFO] RTP packet callback registered
# [INFO] RTSP playback started
# [INFO] WebRTC peer created
# [INFO] Peer subscribed to stream
```

### í™•ì¸ ì‚¬í•­

1. **RTSP ì—°ê²°**
   - âœ… RTSP ì„œë²„ ì—°ê²° ì„±ê³µ ë©”ì‹œì§€
   - âœ… ë¯¸ë””ì–´ í¬ë§· ê°ì§€ (H.264, Opus ë“±)

2. **RTP íŒ¨í‚· ìˆ˜ì‹ **
   - âœ… `packetsReceived` í†µê³„ ì¦ê°€
   - âœ… `bytesReceived` í†µê³„ ì¦ê°€
   - âœ… ë¡œê·¸ì— íŒ¨í‚· ì •ë³´ ì¶œë ¥ (Debug ë ˆë²¨)

3. **WebRTC ì—°ê²°**
   - âœ… SDP Offer/Answer êµí™˜
   - âœ… ICE ì—°ê²° ì„±ê³µ
   - âœ… Peer ì—°ê²° ìƒíƒœ: Connected

4. **ë¹„ë””ì˜¤ ì¬ìƒ**
   - ğŸ¯ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì˜ìƒ ì¬ìƒ
   - ğŸ¯ ì§€ì—°ì‹œê°„ < 1ì´ˆ
   - ğŸ¯ ë¶€ë“œëŸ¬ìš´ ì¬ìƒ (ëŠê¹€ ì—†ìŒ)

---

## ğŸ’¡ í•µì‹¬ í•™ìŠµ í¬ì¸íŠ¸

### gortsplib v4 íŒ¨í„´
- **ì½œë°± ë“±ë¡ ìˆœì„œê°€ ì¤‘ìš”**: `SetupAll()` â†’ `OnPacket*()` â†’ `Play()`
- **ìë™ íŒ¨í‚· ì½ê¸°**: gortsplibê°€ ë‚´ë¶€ ê³ ë£¨í‹´ìœ¼ë¡œ ì²˜ë¦¬
- **ì½œë°± ìë™ í˜¸ì¶œ**: ë³„ë„ íŒ¨í‚· ì½ê¸° ë£¨í”„ ë¶ˆí•„ìš”

### Go ë™ì‹œì„± íŒ¨í„´
- **ì±„ë„ ê¸°ë°˜ Pub/Sub**: íš¨ìœ¨ì ì¸ ìŠ¤íŠ¸ë¦¼ ë°°í¬
- **Context ê¸°ë°˜ ìƒëª…ì£¼ê¸°**: ê³„ì¸µì  ë¦¬ì†ŒìŠ¤ ì •ë¦¬
- **ê³ ë£¨í‹´ ìµœì†Œí™”**: ë¶ˆí•„ìš”í•œ ê³ ë£¨í‹´ ì œê±°ë¡œ ì„±ëŠ¥ í–¥ìƒ

### ë””ë²„ê¹… ê°œì„ 
- **êµ¬ì¡°í™”ëœ ë¡œê¹…**: ë¯¸ë””ì–´ í¬ë§· ì •ë³´ ë¡œê¹…
- **í†µê³„ ìˆ˜ì§‘**: íŒ¨í‚·/ë°”ì´íŠ¸ ì¹´ìš´í„°
- **ìƒíƒœ ì¶”ì **: ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] gortsplib v4 API ì¡°ì‚¬ ì™„ë£Œ
- [x] OnPacketRTPAny ì½œë°± êµ¬í˜„
- [x] ë¯¸ë””ì–´ ì •ë³´ ë¡œê¹… ì¶”ê°€
- [x] readPackets() í•¨ìˆ˜ ì œê±°
- [x] ë¹Œë“œ ì„±ê³µ í™•ì¸
- [x] ë¬¸ì„œ ì‘ì„± ì™„ë£Œ
- [ ] **ë‹¤ìŒ**: ì‹¤ì œ RTSP ì¹´ë©”ë¼ í…ŒìŠ¤íŠ¸
- [ ] ì›¹ ë¸Œë¼ìš°ì € ì¬ìƒ í™•ì¸
- [ ] ì§€ì—°ì‹œê°„ ì¸¡ì •
- [ ] ë‹¤ì¤‘ í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸

---

## ğŸ‰ ì„±ê³¼ ìš”ì•½

### Phase 2 â†’ Phase 3 ì§„í–‰ ì™„ë£Œ
- âœ… **Phase 1**: í”„ë¡œì íŠ¸ êµ¬ì¡° ë° ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸
- âœ… **Phase 2**: gortsplib/pion í†µí•© ë° íŒŒì´í”„ë¼ì¸ êµ¬ì¶•
- âœ… **Phase 3 (Part 1)**: RTP íŒ¨í‚· ìˆ˜ì‹  ì™„ì„±

### ë‚¨ì€ ì‘ì—…
- ğŸ”œ **Phase 3 (Part 2)**: ì‹¤ì œ ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸
- ğŸ”œ **Phase 3 (Part 3)**: ë‹¤ì¤‘ ìŠ¤íŠ¸ë¦¼ ì§€ì›
- ğŸ”œ **Phase 4**: ì„±ëŠ¥ ìµœì í™” ë° í”„ë¡œë•ì…˜ ë°°í¬

---

**í˜„ì¬ ìƒíƒœ**: âœ… ì½”ë“œ ì™„ì„± (í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ)
**ë‹¤ìŒ ì‘ì—…**: ğŸ¬ ì‹¤ì œ RTSP ì¹´ë©”ë¼ë¡œ ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸
**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 30ë¶„ (í…ŒìŠ¤íŠ¸ ë° ê²€ì¦)

---

## ğŸ“ í…ŒìŠ¤íŠ¸ í™˜ê²½

### í…ŒìŠ¤íŠ¸ RTSP ìŠ¤íŠ¸ë¦¼
- **URL**: `rtsp://admin:live0416@192.168.4.121:554/Streaming/Channels/101`
- **í”„ë¡œí† ì½œ**: TCP (ì„¤ì • ê°€ëŠ¥)
- **ì˜ˆìƒ ì½”ë±**: H.264 ë¹„ë””ì˜¤, AAC/Opus ì˜¤ë””ì˜¤

### ì„œë²„ ì„¤ì •
- **HTTP í¬íŠ¸**: 8080
- **WebSocket**: ws://localhost:8080/ws
- **ë¡œê·¸ ë ˆë²¨**: Info (Debugë¡œ ë³€ê²½ ê°€ëŠ¥)

### í´ë¼ì´ì–¸íŠ¸ ìš”êµ¬ì‚¬í•­
- **ë¸Œë¼ìš°ì €**: Chrome 90+ / Firefox 88+ / Edge 90+
- **WebRTC ì§€ì›**: í•„ìˆ˜
- **ë„¤íŠ¸ì›Œí¬**: RTSP ì¹´ë©”ë¼ì™€ ë™ì¼ ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ë¼ìš°íŒ… ê°€ëŠ¥

---

**ë¬¸ì„œ ì‘ì„±ì¼**: 2025-10-29
**ì‘ì„±ì**: Claude Code
**ë²„ì „**: 0.3.0-dev
